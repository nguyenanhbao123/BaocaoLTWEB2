@model BeverageShop.MVC.Models.Beverage

@{
    ViewData["Title"] = Model.Name;
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" alt="@Model.Name" class="img-fluid rounded shadow" style="width: 100%; max-height: 500px; object-fit: cover;" />
            }
            else
            {
                <div class="bg-light d-flex align-items-center justify-content-center rounded shadow" style="height: 400px;">
                    <div class="text-center">
                        <i class="bi bi-cup-hot" style="font-size: 5rem; color: #d63031;"></i>
                        <p class="mt-3 text-muted">@Model.Name</p>
                    </div>
                </div>
            }
        </div>
        <div class="col-md-6">
            <h1>@Model.Name</h1>
            <hr />
            <div class="mb-3">
                <strong>Loại:</strong> <span class="badge bg-primary">@Model.Type</span>
            </div>
            <div class="mb-3">
                <strong>Danh mục:</strong> <span class="badge bg-info">@Model.Category</span>
            </div>
            <div class="mb-3">
                <strong>Size:</strong> <span class="badge bg-secondary">@Model.Size</span>
            </div>
            <div class="mb-3">
                <strong>Giá:</strong> <h3 class="text-danger">@Model.Price.ToString("N0") đ</h3>
            </div>
            <div class="mb-3">
                @if (Model.IsAvailable && Model.Stock > 0)
                {
                    <span class="badge bg-success">Còn hàng (@Model.Stock)</span>
                }
                else
                {
                    <span class="badge bg-danger">Hết hàng</span>
                }
            </div>
            <div class="mb-4">
                <strong>Mô tả:</strong>
                <p>@Model.Description</p>
            </div>

            @if (Model.IsAvailable && Model.Stock > 0)
            {
                <form asp-action="AddToCart" method="post">
                    <input type="hidden" name="BeverageId" value="@Model.Id" />
                    <div class="input-group mb-3" style="max-width: 200px;">
                        <label class="input-group-text">Số lượng</label>
                        <input type="number" name="quantity" value="1" min="1" max="@Model.Stock" class="form-control" />
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-cart-plus"></i> Thêm vào giỏ hàng
                    </button>
                </form>
            }
            else
            {
                <button class="btn btn-secondary btn-lg" disabled>Hết hàng</button>
            }

            <div class="mt-3">
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h2>Đánh giá sản phẩm</h2>
            <hr />
            
            @{
                var stats = ViewBag.ReviewStats as BeverageShop.MVC.Models.ReviewStats;
                var reviews = ViewBag.Reviews as List<BeverageShop.MVC.Models.Review> ?? new List<BeverageShop.MVC.Models.Review>();
            }

            @if (stats != null && stats.TotalReviews > 0)
            {
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h1 class="display-4">@stats.AverageRating</h1>
                                <div class="text-warning mb-2">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= Math.Floor(stats.AverageRating))
                                        {
                                            <i class="bi bi-star-fill"></i>
                                        }
                                        else if (i <= Math.Ceiling(stats.AverageRating))
                                        {
                                            <i class="bi bi-star-half"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-star"></i>
                                        }
                                    }
                                </div>
                                <p class="text-muted">@stats.TotalReviews đánh giá</p>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Add Review Form -->
            @{
                var userJson = Context.Session.GetString("CurrentUser");
                if (!string.IsNullOrEmpty(userJson))
                {
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Viết đánh giá</h5>
                        </div>
                        <div class="card-body">
                            <form asp-action="AddReview" method="post">
                                <input type="hidden" name="BeverageId" value="@Model.Id" />
                                <div class="mb-3">
                                    <label class="form-label">Đánh giá của bạn</label>
                                    <div class="rating-stars">
                                        <input type="radio" name="rating" value="5" id="star5" required />
                                        <label for="star5">★</label>
                                        <input type="radio" name="rating" value="4" id="star4" />
                                        <label for="star4">★</label>
                                        <input type="radio" name="rating" value="3" id="star3" />
                                        <label for="star3">★</label>
                                        <input type="radio" name="rating" value="2" id="star2" />
                                        <label for="star2">★</label>
                                        <input type="radio" name="rating" value="1" id="star1" />
                                        <label for="star1">★</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nhận xét</label>
                                    <textarea name="comment" class="form-control" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-send"></i> Gửi đánh giá
                                </button>
                            </form>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="/Shop/Details/@Model.Id">Đăng nhập</a> 
                        để viết đánh giá
                    </div>
                }
            }

            <!-- Reviews List -->
            @if (reviews.Any())
            {
                <h4 class="mt-4">Các đánh giá (@reviews.Count)</h4>
                @foreach (var review in reviews)
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h5 class="card-title">@review.UserName</h5>
                                <div class="text-warning">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="bi @(i <= review.Rating ? "bi-star-fill" : "bi-star")"></i>
                                    }
                                </div>
                            </div>
                            <p class="card-text">@review.Comment</p>
                            <small class="text-muted">@review.CreatedDate.ToString("dd/MM/yyyy HH:mm")</small>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá!</p>
            }
        </div>
    </div>
</div>

@section Styles {
<style>
.rating-stars {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    font-size: 2rem;
}
.rating-stars input {
    display: none;
}
.rating-stars label {
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s;
}
.rating-stars label:hover,
.rating-stars label:hover ~ label,
.rating-stars input:checked ~ label {
    color: #ffc107;
}
</style>
}


